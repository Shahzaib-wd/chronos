<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Checkout - Chronos</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="css/style.css">
</head>
<body>
  <nav class="navbar scrolled">
    <div class="container">
      <div class="row w-100 align-items-center">
        <div class="col-6">
          <a href="index.html" class="navbar-brand">
            <img src="assets/logo.png.png" alt="CHRONOS">
          </a>
        </div>
        <div class="col-6 text-end">
          <a href="cart.html" class="text-white">‚Üê Back to Cart</a>
        </div>
      </div>
    </div>
  </nav>

  <main class="py-5" style="min-height: 100vh; padding-top: 150px !important; background: #0F1419; color: white;">
    <div class="container">
      <div class="text-center mb-5">
        <h1 class="mb-1">Checkout</h1>
        <p class="text-white-50 mb-0">Cash on Delivery (COD)</p>
      </div>

      <div class="row g-4">
        <div class="col-12 col-lg-7">
          <div class="card p-4" style="background:#111826;border:1px solid rgba(255,255,255,.08)">
            <h3 class="h5 text-gold mb-3">Shipping Details</h3>
            <form id="checkoutForm">
              <div class="row g-3">
                <div class="col-12">
                  <label class="form-label">Full name</label>
                  <input class="form-control" name="full_name" required>
                </div>
                <div class="col-12 col-md-6">
                  <label class="form-label">Phone number</label>
                  <input class="form-control" name="phone" required>
                </div>
                <div class="col-12 col-md-6">
                  <label class="form-label">Email (optional)</label>
                  <input class="form-control" name="email" type="email">
                </div>
                <div class="col-12">
                  <label class="form-label">Address</label>
                  <input class="form-control" name="address" required>
                </div>
                <div class="col-12 col-md-6">
                  <label class="form-label">City</label>
                  <input class="form-control" name="city" required>
                </div>
                <div class="col-12 col-md-6">
                  <label class="form-label">Notes (optional)</label>
                  <input class="form-control" name="notes">
                </div>
              </div>

              <div class="mt-4 d-flex justify-content-between align-items-center">
                <div>
                  <div class="text-white-50 small">Total</div>
                  <div class="h4 mb-0">Rs. <span id="checkoutTotal">0</span></div>
                </div>
                <button type="submit" class="btn-luxury px-4 py-3">Place Order</button>
              </div>
            </form>
          </div>
        </div>

        <div class="col-12 col-lg-5">
          <div class="card p-4" style="background:#111826;border:1px solid rgba(255,255,255,.08)">
            <h3 class="h5 text-gold mb-3">Order Summary</h3>
            <div id="summaryItems" class="d-flex flex-column gap-3"></div>
          </div>
        </div>
      </div>

    </div>
  </main>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script src="js/app.js"></script>
  <script>
    const cart = JSON.parse(localStorage.getItem('chronos_cart')) || [];
    const summary = document.getElementById('summaryItems');
    const totalEl = document.getElementById('checkoutTotal');

    function computeTotal(){
      return cart.reduce((sum,it)=> sum + (Number(it.price)||0) * (Number(it.quantity)||1), 0);
    }

    function render(){
      if(cart.length===0){
        summary.innerHTML = '<p class="text-white-50 mb-0">Your cart is empty.</p>';
        totalEl.textContent = '0';
        return;
      }
      summary.innerHTML = cart.map(it=>`
        <div class="d-flex align-items-center gap-3">
          <img src="${it.image}" style="width:64px;height:64px;object-fit:cover;border-radius:10px" alt="${it.name}">
          <div class="flex-grow-1">
            <div class="fw-semibold">${it.name}</div>
            <div class="small text-white-50">Qty: ${it.quantity||1}</div>
          </div>
          <div class="text-end">Rs. ${(Number(it.price)||0).toLocaleString()}</div>
        </div>
      `).join('');
      totalEl.textContent = computeTotal().toLocaleString();
    }

    render();

    document.getElementById('checkoutForm').addEventListener('submit', async (e)=>{
      e.preventDefault();
      if(cart.length===0){
        showNotification('Your cart is empty', 'error');
        return;
      }
      const fd = new FormData(e.target);
      const customer = {
        full_name: (fd.get('full_name')||'').toString(),
        phone: (fd.get('phone')||'').toString(),
        email: (fd.get('email')||'').toString(),
        address: (fd.get('address')||'').toString(),
        city: (fd.get('city')||'').toString(),
        notes: (fd.get('notes')||'').toString(),
      };

      // Normalize for backend: try to map localStorage items to product_id if present
      const items = cart.map(it=>({
        product_id: Number(it.product_id || it.id || 0),
        qty: Number(it.quantity||1)
      }));

      try{
        const r = await fetch('api/checkout.php', {
          method:'POST',
          headers:{'Content-Type':'application/json'},
          body: JSON.stringify({customer, items})
        });
        const res = await r.json();
        if(res.success){
          localStorage.removeItem('chronos_cart');
          window.location.href = 'order-confirmation.html?order_uid=' + encodeURIComponent(res.data.order_uid);
        } else {
          showNotification(res.message || 'Checkout failed', 'error');
        }
      }catch(err){
        showNotification('Checkout failed', 'error');
      }
    });
  </script>
</body>
</html>
